
#include <stdio.h>
#include <SDK.h>
#include <math.h>
#include <Motor.h>
#include <ReorientableBehavior.h>
#include "Interpolator.h"

#if defined(ROBOT_MINITAUR)
// Subject to change for individual robots
// const float motZeros[8] = {2.82, 3.435, 3.54, 3.076, 1.03, 3.08, 6.190, 1.493};
// const float motZeros[8] = {2.570, 3.167, 3.777, 3.853, 2.183, 1.556, .675, 2.679}; // RML Ellie
// const float motZeros[9] = {2.570, 3.167, 3.777, 3.853, 2.183, 1.556, .675, 2.679, 1.010}; // RML Ellie With Tail
// const float motZeros[8] = {0.631, 4.076, 1.852, 3.414, 1.817, 5.500, 1.078, 6.252}; //RML Odie
const float motZeros[9] = {0.631, 4.076, 1.852, 3.414, 1.817, 5.500, 1.078, 6.252, 1.010}; //RML Odie with Tail
#endif


#define TIMESTEPS 84
#define MOTORS 9 
#define TAIL_MOT 8

char myData[32];
float* myData_buf = (float*)myData;

enum TBMode
{
	TB_SIT = 0,
	TB_STAND,
};

float times[TIMESTEPS] = {0.000000,0.000188,0.000375,0.000563,0.000751,0.000938,0.001126,0.001314,0.001501,0.001689,0.001877,0.002064,0.002252,0.002440,0.002627,0.002815,0.003002,0.003190,0.003378,0.003565,0.003753,0.003753,0.007720,0.011687,0.015654,0.019621,0.023588,0.027555,0.031522,0.035489,0.039456,0.043423,0.047390,0.051357,0.055324,0.059291,0.063259,0.067226,0.071193,0.075160,0.079127,0.083094,0.083094,0.083255,0.083417,0.083578,0.083740,0.083901,0.084062,0.084224,0.084385,0.084547,0.084708,0.084870,0.085031,0.085193,0.085354,0.085516,0.085677,0.085839,0.086000,0.086161,0.086323,0.086323,0.090768,0.095212,0.099657,0.104102,0.108546,0.112991,0.117436,0.121880,0.126325,0.130770,0.135215,0.139659,0.144104,0.148549,0.152993,0.157438,0.161883,0.166327,0.170772,0.175217};
float pos[TIMESTEPS][MOTORS] = {{0.521626,0.198348,0.477523,1.304641,0.198436,0.521542,1.304733,0.477532,-0.374024},{0.524061,0.199216,0.479575,1.308249,0.199247,0.524032,1.308301,0.479581,-0.373795},{0.526583,0.200000,0.481687,1.311921,0.200087,0.526498,1.312012,0.481695,-0.373639},{0.529023,0.200872,0.483731,1.315514,0.200902,0.528994,1.315565,0.483737,-0.373410},{0.531549,0.201663,0.485852,1.319173,0.201749,0.531464,1.319264,0.485860,-0.373255},{0.533994,0.202540,0.487897,1.322753,0.202570,0.533964,1.322805,0.487903,-0.373029},{0.536524,0.203336,0.490019,1.326399,0.203422,0.536438,1.326490,0.490027,-0.372874},{0.538973,0.204218,0.492065,1.329966,0.204248,0.538943,1.330017,0.492070,-0.372649},{0.541507,0.205019,0.494187,1.333599,0.205106,0.541419,1.333690,0.494195,-0.372495},{0.543959,0.205907,0.496234,1.337153,0.205936,0.543929,1.337204,0.496239,-0.372271},{0.546497,0.206713,0.498357,1.340773,0.206799,0.546409,1.340864,0.498364,-0.372117},{0.548954,0.207605,0.500404,1.344313,0.207635,0.548923,1.344365,0.500409,-0.371895},{0.551496,0.208417,0.502528,1.347920,0.208503,0.551406,1.348011,0.502535,-0.371741},{0.553955,0.209314,0.504576,1.351448,0.209344,0.553924,1.351499,0.504580,-0.371521},{0.556501,0.210131,0.506700,1.355042,0.210218,0.556410,1.355133,0.506708,-0.371368},{0.558965,0.211034,0.508749,1.358557,0.211064,0.558933,1.358608,0.508754,-0.371149},{0.561515,0.211855,0.510875,1.362138,0.211942,0.561422,1.362229,0.510882,-0.370996},{0.563981,0.212763,0.512924,1.365640,0.212793,0.563949,1.365691,0.512928,-0.370779},{0.566535,0.213589,0.515050,1.369208,0.213677,0.566441,1.369299,0.515057,-0.370626},{0.569005,0.214502,0.517101,1.372698,0.214533,0.568971,1.372749,0.517105,-0.370410},{0.571563,0.215333,0.519227,1.376253,0.215422,0.571466,1.376344,0.519234,-0.370259},{0.571463,0.215234,0.519128,1.376153,0.215324,0.571536,1.376244,0.519134,-0.370159},{0.509975,0.197572,0.542416,1.431959,0.197662,0.510030,1.432049,0.542420,-0.359538},{0.457997,0.193964,0.555891,1.455710,0.194054,0.458033,1.455802,0.555896,-0.348837},{0.414016,0.202812,0.562610,1.455229,0.202840,0.414051,1.455317,0.562598,-0.337858},{0.377647,0.222353,0.564375,1.434632,0.222319,0.377682,1.434724,0.564358,-0.327018},{0.348038,0.251962,0.563385,1.397255,0.251928,0.348073,1.397332,0.563358,-0.316748},{0.326200,0.292200,0.560862,1.345060,0.292165,0.326201,1.345152,0.560854,-0.307343},{0.313966,0.346543,0.558182,1.280127,0.346509,0.313968,1.280184,0.558171,-0.299258},{0.310880,0.413245,0.557175,1.205312,0.413211,0.310881,1.205405,0.557170,-0.293225},{0.312844,0.487121,0.562344,1.126161,0.487087,0.312846,1.126251,0.562331,-0.292227},{0.319365,0.566392,0.573890,1.045215,0.566359,0.319366,1.045309,0.573886,-0.295916},{0.331575,0.653670,0.590232,0.963775,0.653637,0.331576,0.963843,0.590231,-0.302738},{0.350310,0.749030,0.609158,0.883007,0.748997,0.350311,0.883101,0.609157,-0.310529},{0.375143,0.852595,0.628883,0.803631,0.852562,0.375145,0.803720,0.628871,-0.317714},{0.405135,0.961705,0.648386,0.727382,0.961673,0.405136,0.727477,0.648387,-0.323384},{0.437966,1.073646,0.666704,0.655544,1.073615,0.437967,0.655621,0.666698,-0.326694},{0.471988,1.184881,0.684215,0.590436,1.184850,0.471990,0.590531,0.684217,-0.328214},{0.504645,1.292413,0.701265,0.534228,1.292381,0.504646,0.534317,0.701188,-0.328277},{0.535007,1.394671,0.718377,0.488829,1.394639,0.535008,0.488924,0.718380,-0.328203},{0.561947,1.490110,0.736457,0.456463,1.490079,0.561945,0.456557,0.736488,-0.328997},{0.584382,1.578213,0.756399,0.439054,1.578183,0.584384,0.439149,0.756461,-0.331564},{0.584482,1.578113,0.756498,0.438954,1.578083,0.584484,0.439049,0.756416,-0.331464},{0.585248,1.581365,0.757442,0.438635,1.581347,0.585249,0.438667,0.757402,-0.331569},{0.585905,1.584735,0.758351,0.438241,1.584704,0.585906,0.438336,0.758268,-0.331699},{0.586595,1.587976,0.759250,0.437924,1.587959,0.586595,0.437956,0.759222,-0.331792},{0.587326,1.591336,0.760207,0.437535,1.591305,0.587328,0.437631,0.760123,-0.331936},{0.588016,1.594567,0.761107,0.437222,1.594550,0.588017,0.437254,0.761079,-0.332029},{0.588747,1.597917,0.762066,0.436837,1.597886,0.588749,0.436932,0.761981,-0.332174},{0.589437,1.601139,0.762967,0.436527,1.601122,0.589438,0.436559,0.762938,-0.332268},{0.590167,1.604478,0.763927,0.436145,1.604448,0.590169,0.436241,0.763842,-0.332414},{0.590857,1.607691,0.764830,0.435840,1.607674,0.590858,0.435872,0.764801,-0.332508},{0.591587,1.611020,0.765791,0.435461,1.610990,0.591589,0.435557,0.765705,-0.332655},{0.592276,1.614223,0.766695,0.435159,1.614207,0.592277,0.435191,0.766665,-0.332749},{0.593005,1.617543,0.767658,0.434784,1.617513,0.593007,0.434881,0.767570,-0.332897},{0.593695,1.620736,0.768563,0.434486,1.620720,0.593696,0.434518,0.768533,-0.332992},{0.594423,1.624046,0.769527,0.434114,1.624016,0.594425,0.434211,0.769438,-0.333141},{0.595113,1.627230,0.770433,0.433820,1.627214,0.595113,0.433852,0.770402,-0.333237},{0.595841,1.630530,0.771399,0.433452,1.630500,0.595843,0.433549,0.771308,-0.333387},{0.596530,1.633705,0.772305,0.433161,1.633689,0.596531,0.433194,0.772274,-0.333483},{0.597257,1.636995,0.773273,0.432796,1.636965,0.597259,0.432894,0.773180,-0.333634},{0.597946,1.640161,0.774178,0.432510,1.640145,0.597947,0.432543,0.774145,-0.333730},{0.598673,1.643441,0.775150,0.432149,1.643412,0.598676,0.432247,0.775052,-0.333882},{0.598573,1.643341,0.775050,0.432049,1.643312,0.598576,0.432148,0.774956,-0.333782},{0.609796,1.701461,0.673679,0.388048,1.701442,0.609799,0.388148,0.673585,-0.345266},{0.608560,1.722632,0.582763,0.352962,1.722604,0.608563,0.353062,0.582670,-0.359779},{0.598223,1.715743,0.502110,0.327378,1.715733,0.598239,0.327477,0.502017,-0.376193},{0.580198,1.684480,0.431165,0.311425,1.684453,0.580219,0.311523,0.431072,-0.393678},{0.555495,1.630020,0.370978,0.306848,1.629999,0.555486,0.306946,0.370886,-0.411072},{0.525149,1.553091,0.320689,0.313190,1.553065,0.525075,0.313287,0.320597,-0.427917},{0.489400,1.452928,0.279540,0.329881,1.452903,0.489330,0.329976,0.279454,-0.443042},{0.450590,1.331968,0.245326,0.354674,1.331943,0.450508,0.354766,0.245235,-0.455604},{0.411075,1.193320,0.215351,0.384649,1.193297,0.410994,0.384740,0.215260,-0.463452},{0.375127,1.044680,0.189075,0.419764,1.044658,0.375043,0.419855,0.188991,-0.465845},{0.347811,0.897443,0.167952,0.462489,0.897450,0.347727,0.462580,0.167868,-0.461060},{0.331553,0.758644,0.156416,0.517120,0.758697,0.331468,0.517211,0.156332,-0.450811},{0.325374,0.629998,0.162063,0.592242,0.630061,0.325292,0.592334,0.161978,-0.438625},{0.329144,0.513460,0.185731,0.685909,0.513539,0.329059,0.686001,0.185646,-0.426687},{0.342242,0.412146,0.221844,0.790293,0.412224,0.342150,0.790385,0.221760,-0.414480},{0.364281,0.327825,0.265980,0.898589,0.327910,0.364195,0.898680,0.265896,-0.402873},{0.394200,0.262549,0.316022,1.006963,0.262635,0.394118,1.007055,0.315937,-0.392590},{0.430867,0.217786,0.369257,1.112042,0.217873,0.430782,1.112133,0.369172,-0.384491},{0.472334,0.195120,0.423991,1.211909,0.195206,0.472246,1.211966,0.423906,-0.378445},{0.521529,0.198448,0.477516,1.304741,0.198536,0.521443,1.304833,0.477432,-0.374124}};
float vel[TIMESTEPS][MOTORS] = {{12.925103,4.643015,11.357532,19.701280,4.643016,12.925187,19.701187,11.357484,0.762102},{12.942026,4.662910,11.359901,19.662035,4.662911,12.942031,19.662023,11.359893,0.759521},{12.956162,4.680018,11.362086,19.624749,4.680020,12.956159,19.624749,11.362086,0.756966},{12.967122,4.693875,11.364028,19.589642,4.693876,12.967119,19.589640,11.364024,0.754561},{12.977975,4.707707,11.365986,19.554620,4.707709,12.977976,19.554619,11.365980,0.752079},{12.988754,4.721517,11.367934,19.519628,4.721518,12.988750,19.519627,11.367929,0.749645},{12.999424,4.735302,11.369896,19.484729,4.735303,12.999421,19.484729,11.369892,0.747132},{13.010015,4.749065,11.371846,19.449869,4.749065,13.010010,19.449869,11.371841,0.744665},{13.020495,4.762805,11.373813,19.415098,4.762804,13.020491,19.415099,11.373809,0.742120},{13.030890,4.776524,11.375773,19.380362,4.776524,13.030885,19.380362,11.375769,0.739622},{13.041179,4.790215,11.377747,19.345717,4.790214,13.041176,19.345720,11.377743,0.737046},{13.051391,4.803877,11.379710,19.311113,4.803877,13.051385,19.311113,11.379705,0.734515},{13.061494,4.817512,11.381692,19.276593,4.817510,13.061490,19.276596,11.381688,0.731907},{13.071518,4.831116,11.383669,19.242106,4.831116,13.071512,19.242107,11.383664,0.729346},{13.081426,4.844701,11.385664,19.207708,4.844699,13.081422,19.207713,11.385660,0.726707},{13.091245,4.858266,11.387654,19.173351,4.858265,13.091239,19.173352,11.387650,0.724115},{13.100963,4.871797,11.389660,19.139081,4.871793,13.100958,19.139087,11.389656,0.721444},{13.110607,4.885286,11.391655,19.104853,4.885287,13.110603,19.104853,11.391652,0.718818},{13.120145,4.898747,11.393668,19.070714,4.898749,13.120143,19.070721,11.393665,0.716112},{13.129502,4.912028,11.395493,19.036765,4.912030,13.129497,19.036770,11.395487,0.713503},{13.139384,4.926198,11.398435,19.001999,4.926157,13.139349,19.002063,11.398403,0.710510},{-16.702951,-6.389116,7.262134,18.686179,-6.389016,-16.702852,18.686082,7.262038,2.705236},{-14.292506,-2.642085,4.512659,9.731984,-2.642049,-14.292599,9.731990,4.512634,2.667655},{-12.009218,0.796929,2.414195,2.625378,0.797021,-12.009263,2.625420,2.414164,2.672717},{-10.139566,3.577142,0.989436,-2.768332,3.577204,-10.139648,-2.768268,0.989428,2.762865},{-8.271575,6.287821,0.015899,-7.416391,6.287791,-8.271614,-7.416339,0.015932,2.700453},{-6.568884,8.715330,-0.485123,-11.364549,8.715330,-6.568819,-11.364490,-0.485113,2.482345},{-4.434437,11.746599,-0.657475,-14.787453,11.746673,-4.434371,-14.787386,-0.657447,2.173041},{-1.825694,15.447517,-0.585223,-17.786723,15.447596,-1.825706,-17.786662,-0.585202,1.847352},{0.076422,18.077505,0.284960,-19.672084,18.077573,0.076349,-19.672017,0.284990,1.038643},{0.997986,19.228708,2.172145,-20.210989,19.228782,0.997938,-20.210930,2.172153,-0.430922},{2.272996,20.897967,3.592760,-20.478902,20.898050,2.272951,-20.478842,3.592775,-1.425085},{3.897709,23.055499,4.505896,-20.478427,23.055563,3.897734,-20.478357,4.505924,-1.921839},{5.461787,25.072822,4.981147,-20.199600,25.072870,5.461839,-20.199533,4.981176,-2.014008},{6.990353,26.966462,4.953049,-19.674371,26.966498,6.990405,-19.674345,4.953020,-1.649205},{7.961616,27.968916,4.798281,-18.715893,27.968968,7.961686,-18.715806,4.798370,-1.186709},{8.514433,28.292119,4.479183,-17.342786,28.292196,8.514467,-17.342866,4.479088,-0.589106},{8.461905,27.711739,4.306257,-15.400776,27.711814,8.461914,-15.400683,4.306353,-0.185198},{7.978210,26.515187,4.260264,-12.877105,26.515210,7.978140,-12.877198,4.260167,0.037492},{7.206310,24.952926,4.412818,-9.853277,24.953001,7.206262,-9.853179,4.412917,-0.031369},{6.256260,23.192372,4.715058,-6.375057,23.192468,6.256349,-6.375156,4.714959,-0.390372},{5.032531,21.154378,5.449408,-2.212911,21.154390,5.032435,-2.212813,5.449506,-1.024924},{4.717578,20.848584,5.422322,-1.912456,20.848553,4.717503,-1.912383,5.422301,-1.032893},{4.714587,20.813408,5.428890,-1.898475,20.813410,4.714580,-1.898465,5.428882,-1.036827},{4.712461,20.780392,5.434374,-1.885938,20.780399,4.712463,-1.885940,5.434363,-1.040065},{4.711299,20.749830,5.438596,-1.875116,20.749835,4.711298,-1.875111,5.438592,-1.042442},{4.710167,20.719345,5.442785,-1.864239,20.719350,4.710159,-1.864231,5.442780,-1.044837},{4.709039,20.688901,5.446946,-1.853341,20.688906,4.709038,-1.853336,5.446943,-1.047188},{4.707930,20.658548,5.451073,-1.842389,20.658554,4.707924,-1.842382,5.451069,-1.049553},{4.706810,20.628254,5.455176,-1.831412,20.628259,4.706809,-1.831406,5.455173,-1.051868},{4.705714,20.598047,5.459244,-1.820386,20.598052,4.705709,-1.820380,5.459240,-1.054199},{4.704617,20.567893,5.463286,-1.809345,20.567898,4.704616,-1.809339,5.463283,-1.056480},{4.703540,20.537829,5.467292,-1.798253,20.537835,4.703537,-1.798247,5.467289,-1.058777},{4.702461,20.507820,5.471273,-1.787145,20.507825,4.702461,-1.787140,5.471270,-1.061025},{4.701396,20.477908,5.475219,-1.775989,20.477914,4.701395,-1.775983,5.475217,-1.063285},{4.700321,20.448061,5.479144,-1.764821,20.448066,4.700322,-1.764815,5.479141,-1.065493},{4.699267,20.418300,5.483030,-1.753594,20.418307,4.699267,-1.753589,5.483027,-1.067718},{4.698213,20.388593,5.486889,-1.742345,20.388599,4.698214,-1.742339,5.486886,-1.069895},{4.697183,20.358969,5.490710,-1.731042,20.358977,4.697184,-1.731037,5.490708,-1.072090},{4.696162,20.329394,5.494503,-1.719722,20.329398,4.696162,-1.719716,5.494500,-1.074239},{4.695149,20.299919,5.498263,-1.708351,20.299922,4.695146,-1.708346,5.498261,-1.076401},{4.694184,20.270735,5.502147,-1.696970,20.270739,4.694184,-1.696963,5.502143,-1.078442},{4.692857,20.240293,5.505127,-1.685516,20.240319,4.692860,-1.685513,5.505126,-1.080898},{4.077741,17.849519,-24.040590,-10.898092,17.849586,4.077807,-10.898101,-24.040512,-2.115053},{1.009397,8.617042,-21.641765,-8.938162,8.617106,1.009416,-8.938227,-21.641688,-2.983215},{-1.440605,1.268069,-19.246352,-6.797057,1.268132,-1.440582,-6.797131,-19.246283,-3.566587},{-3.224479,-4.328836,-17.088973,-4.733234,-4.328771,-3.224474,-4.733320,-17.088890,-3.854872},{-4.821825,-9.636516,-14.788364,-2.373674,-9.636460,-4.821818,-2.373765,-14.788278,-3.961652},{-6.237246,-14.786299,-12.400093,0.217040,-14.786251,-6.237235,0.216961,-12.400040,-3.897409},{-7.446093,-19.833667,-10.245775,2.629191,-19.833619,-7.446132,2.629121,-10.245753,-3.626386},{-8.508367,-25.017093,-8.409006,4.734856,-25.017044,-8.508382,4.734783,-8.408996,-3.186071},{-8.911380,-29.280365,-7.052541,6.364037,-29.280343,-8.911424,6.363982,-7.052501,-2.384496},{-8.673907,-32.673950,-6.419603,7.217541,-32.673897,-8.673910,7.217480,-6.419594,-1.188248},{-7.394265,-33.864768,-5.298942,8.766485,-33.864721,-7.394292,8.766511,-5.298913,0.157914},{-4.894467,-32.247667,-3.934254,10.699783,-32.247608,-4.894463,10.699781,-3.934319,1.803963},{-2.506273,-30.140782,-1.074791,14.213707,-30.140722,-2.506269,14.213794,-1.074879,2.706248},{-0.270052,-27.669174,3.462091,19.282898,-27.669111,-0.270031,19.282967,3.462129,2.706270},{1.893426,-24.605739,6.945075,22.648536,-24.605669,1.893440,22.648440,6.945090,2.683350},{3.976064,-20.937955,9.127317,24.117913,-20.937903,3.976104,24.117919,9.127265,2.705106},{5.851241,-16.871081,10.643874,24.498064,-16.871030,5.851238,24.498056,10.643808,2.502319},{7.513755,-12.445403,11.706539,24.134501,-12.445315,7.513790,24.134404,11.706444,2.057806},{8.969932,-7.552444,12.170317,23.104428,-7.552374,8.970013,23.104331,12.170218,1.606548},{9.905037,-2.416578,12.279417,21.750272,-2.416665,9.904948,21.750367,12.279517,1.142864},{12.536525,4.234069,11.715845,20.026970,4.234160,12.536578,20.026875,11.715745,0.752057}};
// float acc[TIMESTEPS][MOTORS] = {{87.523241,103.240157,12.469463,-207.115944,103.247751,87.283403,-206.813339,12.640331,-14.119863},{87.484393,103.306596,12.142097,-207.010095,103.314655,87.254781,-206.712208,12.303668,-14.077748},{58.212529,73.556776,10.297116,-186.756591,73.556710,58.262622,-186.761840,10.273401,-13.283402},{58.136308,73.569522,10.066365,-186.667561,73.567833,58.182923,-186.673366,10.048798,-13.247791},{57.278760,73.307577,10.321013,-186.140904,73.302734,57.277758,-186.136161,10.333099,-13.442685},{57.200714,73.316165,10.093639,-186.046658,73.311463,57.200635,-186.043150,10.107374,-13.407483},{56.307914,73.058649,10.331883,-185.441490,73.056315,56.307445,-185.438354,10.335834,-13.616681},{56.229997,73.064588,10.106119,-185.342827,73.062114,56.230141,-185.340409,10.111647,-13.581893},{55.299114,72.828456,10.382782,-184.785722,72.826584,55.294973,-184.781937,10.387245,-13.779499},{55.221128,72.831911,10.158748,-184.682413,72.829908,55.217838,-184.679028,10.163882,-13.745126},{54.348333,72.524773,10.399926,-184.094136,72.524128,54.342798,-184.091408,10.403953,-13.954554},{54.269995,72.525914,10.177878,-183.986168,72.525214,54.265476,-183.983487,10.181957,-13.920599},{53.371139,72.227553,10.474285,-183.468091,72.226290,53.364088,-183.464902,10.477122,-14.115940},{53.292599,72.226451,10.253735,-183.355127,72.225387,53.286796,-183.351665,10.256120,-14.082402},{52.320523,72.010542,10.539628,-182.786813,72.000423,52.311579,-182.783112,10.543272,-14.281749},{52.242563,72.007348,10.320587,-182.668707,71.997174,52.233815,-182.664455,10.323364,-14.248629},{51.401485,71.605112,10.565143,-182.093786,71.631654,51.420539,-182.106703,10.580627,-14.462738},{51.322746,71.599602,10.347344,-181.969863,71.626711,51.342688,-181.981790,10.362520,-14.430037},{50.460946,71.308375,10.641375,-181.434182,71.282072,50.418900,-181.350974,10.598244,-14.643642},{50.378199,71.298813,10.426660,-181.303250,71.277814,50.345013,-181.218614,10.384007,-14.611378},{56.253876,80.829104,22.368389,-190.314655,80.248745,55.846956,-189.819074,22.157648,-18.078295},{511.465184,827.151569,-676.198717,-2263.733089,827.117750,511.392423,-2263.721065,-676.187327,-3.330717},{647.665141,983.865691,-660.487462,-2137.392207,983.871756,647.659848,-2137.373375,-660.477077,-9.900202},{447.358017,671.790229,-347.976598,-1332.341358,671.794049,447.342376,-1332.323948,-347.963796,18.263602},{483.121989,711.010124,-336.286138,-1326.252441,710.992953,483.120510,-1326.254163,-336.277208,15.346731},{446.610695,636.641798,-120.509250,-956.498011,636.614490,446.637181,-956.500840,-120.484189,-58.751319},{447.680649,637.652994,-108.459543,-981.491659,637.680107,447.699439,-981.485560,-108.465346,-58.885397},{664.364616,940.933094,45.159380,-691.706108,940.930108,664.342155,-691.716061,45.177935,-104.629067},{609.656953,861.466563,55.041215,-717.991322,861.469048,609.640626,-717.986682,55.043541,-101.317602},{308.196498,400.919709,447.398988,-130.176331,400.909039,308.178503,-130.184706,447.397723,-348.045719},{216.609167,267.520409,460.477161,-121.564246,267.527657,216.612715,-121.563614,460.467843,-351.728937},{486.415435,662.002625,212.147031,6.364377,661.994780,486.440682,6.365283,212.149690,-108.268052},{367.267181,476.004994,211.596511,14.578649,476.001835,367.276717,14.580975,211.599495,-108.244181},{455.912288,591.218230,-8.617251,146.612957,591.212589,455.921874,146.607499,-8.646163,95.805639},{314.858626,364.289091,-14.295340,152.635523,364.288629,314.860258,152.626089,-14.322122,96.175239},{175.033232,141.824553,-72.524380,364.947297,141.835015,175.030862,365.005580,-72.363855,145.049578},{83.322396,-5.604368,-75.170450,372.615242,-5.601800,83.314275,372.516682,-75.336097,141.238025},{-130.061714,-313.818518,1.073954,651.667497,-313.820852,-130.072978,652.008284,1.613602,47.299103},{-136.067026,-318.531193,-5.379529,659.969934,-318.543631,-136.084444,659.705758,-5.767747,42.139634},{-275.267098,-498.288837,101.074588,903.727502,-498.236947,-275.229929,904.443126,102.005455,-99.602512},{-238.885026,-434.035820,90.989196,906.418239,-434.016050,-238.866970,905.964088,90.451794,-103.352246},{-413.145921,-638.083119,318.825599,1248.432940,-638.261543,-413.297856,1249.545973,320.155191,-238.423054},{-17.774964,-215.414315,39.794510,84.756171,-215.271510,-17.482900,84.467922,39.786395,-23.989470},{-17.917808,-215.190655,39.807586,84.851494,-215.050979,-17.628938,84.567087,39.812229,-24.000079},{-7.362715,-188.986368,26.337040,66.800742,-188.993262,-7.405172,66.842538,26.349613,-15.108204},{-7.461523,-188.799286,26.347449,66.845806,-188.804541,-7.498615,66.881776,26.353518,-15.117315},{-7.159363,-188.240691,25.961096,67.261914,-188.238630,-7.156613,67.263380,25.952374,-14.941246},{-7.257126,-188.051551,25.966713,67.304905,-188.048384,-7.251944,67.304016,25.957885,-14.950122},{-7.110276,-187.321015,25.598021,67.750011,-187.321456,-7.110965,67.751703,25.590839,-14.721574},{-7.207172,-187.130479,25.601832,67.792322,-187.129629,-7.205407,67.792177,25.594645,-14.730225},{-6.975167,-186.447735,25.223440,68.151472,-186.447870,-6.972703,68.151131,25.221504,-14.515527},{-7.071607,-186.255700,25.225956,68.193464,-186.254561,-7.067107,68.191561,25.223439,-14.523953},{-6.871495,-185.543147,24.843883,68.564119,-185.543763,-6.869403,68.563838,24.843459,-14.302443},{-6.967397,-185.349656,24.844981,68.605854,-185.348977,-6.963442,68.604239,24.843762,-14.310646},{-6.842456,-184.555988,24.492057,68.947135,-184.554306,-6.839454,68.947320,24.491862,-14.061509},{-6.937346,-184.361167,24.491678,68.988700,-184.358157,-6.932559,68.987762,24.490679,-14.069494},{-6.713421,-183.690096,24.093136,69.446147,-183.686335,-6.709254,69.445835,24.093364,-13.869777},{-6.808366,-183.493634,24.091398,69.487340,-183.488325,-6.801904,69.486077,24.090881,-13.877546},{-6.522912,-182.855311,23.689242,69.881294,-182.879635,-6.539045,69.882487,23.688651,-13.693018},{-6.617886,-182.656602,23.686358,69.922183,-182.679475,-6.632438,69.922453,23.684937,-13.700572},{-6.550209,-181.836509,23.352189,70.280641,-181.808548,-6.553495,70.283693,23.351869,-13.440872},{-6.641858,-181.636681,23.348161,70.321743,-181.608916,-6.648631,70.323880,23.346660,-13.448238},{-11.208440,-197.635905,12.237508,70.953555,-197.339269,-11.083782,70.903087,12.266647,-18.172218},{-669.095697,-2093.453011,429.980374,303.956774,-2093.451550,-669.110762,303.929952,429.986210,-190.052074},{-666.175566,-1963.088275,594.381650,519.690701,-1963.090563,-666.181327,519.687806,594.377702,-181.981242},{-390.817579,-1245.986813,428.357752,385.393695,-1245.982354,-390.830425,385.388021,428.361638,-61.821217},{-396.112577,-1249.555607,521.956473,520.477681,-1249.557675,-396.115233,520.476649,521.958621,-56.208835},{-306.866907,-1115.912119,492.724435,518.381161,-1115.912702,-306.875519,518.379306,492.723791,19.935282},{-312.609227,-1174.203346,546.440911,605.121586,-1174.207248,-312.610596,605.126905,546.435118,23.306538},{-213.916452,-1069.904156,387.523159,437.946843,-1069.893254,-213.954537,437.941806,387.503180,113.063821},{-214.431282,-1162.565657,399.059907,464.886825,-1162.574305,-214.424417,464.889725,399.068517,112.352036},{82.688691,-655.935441,171.483791,223.454985,-655.929615,82.683016,223.458579,171.481643,275.690990},{97.444237,-693.369634,155.257553,215.469114,-693.367702,97.443635,215.470689,155.251700,274.303686},{551.589925,335.179837,391.032507,536.298848,335.182501,551.603162,536.343491,391.050881,343.059268},{561.589343,405.736620,349.079217,473.246320,405.738117,561.588286,473.221515,349.043229,342.152354},{501.316387,555.491047,1063.728536,1247.454477,555.491735,501.325794,1247.550301,1063.775093,8.294163},{499.949089,589.700850,939.932285,991.249188,589.701098,499.947393,991.186946,939.945219,-5.424535},{468.541548,821.718054,589.585878,480.810584,821.723034,468.549931,480.839715,589.556471,-2.118603},{456.909088,849.433419,404.192049,194.254515,849.424256,456.914241,194.268629,404.192477,-4.222941},{375.177230,1001.216980,290.130798,-9.399319,1001.235436,375.148122,-9.425349,290.103599,-103.246420},{361.856413,1019.281875,179.852875,-155.446400,1019.276127,361.903427,-155.459555,179.845608,-98.809734},{282.369511,1211.416460,20.684321,-309.400362,1211.391347,282.273472,-309.382164,20.717169,-106.194099},{269.824685,1212.757767,-11.364418,-323.036490,1212.699930,269.800385,-322.992416,-11.324573,-99.327394},{1045.617929,1892.944869,-281.911412,-475.555470,1893.216243,1045.825730,-475.749558,-282.238234,-73.313314}};
float u[TIMESTEPS][MOTORS] = {{0.035804,0.047535,0.005997,-0.061689,0.047558,0.035695,-0.061512,0.006061,-0.024962},{0.035804,0.047535,0.005997,-0.061689,0.047558,0.035695,-0.061512,0.006061,-0.024962},{0.024943,0.035308,0.003073,-0.048518,0.035304,0.024965,-0.048516,0.003060,-0.023123},{0.024943,0.035308,0.003073,-0.048518,0.035304,0.024965,-0.048516,0.003060,-0.023123},{0.024659,0.035365,0.003099,-0.048348,0.035363,0.024659,-0.048345,0.003104,-0.023498},{0.024659,0.035365,0.003099,-0.048348,0.035363,0.024659,-0.048345,0.003104,-0.023498},{0.024356,0.035434,0.003097,-0.048131,0.035433,0.024356,-0.048127,0.003098,-0.023897},{0.024356,0.035434,0.003097,-0.048131,0.035433,0.024356,-0.048127,0.003098,-0.023897},{0.024034,0.035515,0.003132,-0.047949,0.035514,0.024033,-0.047945,0.003132,-0.024274},{0.024034,0.035515,0.003132,-0.047949,0.035514,0.024033,-0.047945,0.003132,-0.024274},{0.023745,0.035560,0.003133,-0.047747,0.035561,0.023743,-0.047743,0.003133,-0.024671},{0.023745,0.035560,0.003133,-0.047747,0.035561,0.023743,-0.047743,0.003133,-0.024671},{0.023444,0.035610,0.003185,-0.047597,0.035610,0.023441,-0.047592,0.003184,-0.025042},{0.023444,0.035610,0.003185,-0.047597,0.035610,0.023441,-0.047592,0.003184,-0.025042},{0.023100,0.035709,0.003224,-0.047417,0.035705,0.023097,-0.047411,0.003223,-0.025420},{0.023100,0.035709,0.003224,-0.047417,0.035705,0.023097,-0.047411,0.003223,-0.025420},{0.022835,0.035710,0.003225,-0.047231,0.035722,0.022842,-0.047238,0.003233,-0.025821},{0.022835,0.035710,0.003225,-0.047231,0.035722,0.022842,-0.047238,0.003233,-0.025821},{0.022548,0.035768,0.003262,-0.047080,0.035761,0.022534,-0.047016,0.003223,-0.026221},{0.022548,0.035768,0.003262,-0.047080,0.035761,0.022534,-0.047016,0.003223,-0.026221},{0.024500,0.041322,0.009354,-0.055022,0.041070,0.024361,-0.054664,0.009162,-0.032012},{0.285717,0.769224,-0.120258,-1.389549,0.768887,0.286698,-1.389599,-0.120267,-0.198288},{0.285717,0.769224,-0.120258,-1.389549,0.768887,0.286698,-1.389599,-0.120267,-0.198288},{0.146642,0.478885,-0.016725,-0.892683,0.479058,0.146682,-0.892714,-0.016729,-0.071399},{0.146642,0.478885,-0.016725,-0.892683,0.479058,0.146682,-0.892714,-0.016729,-0.071399},{0.256775,0.435380,0.020339,-0.666982,0.435491,0.256906,-0.666991,0.020331,-0.208819},{0.256775,0.435380,0.020339,-0.666982,0.435491,0.256906,-0.666991,0.020331,-0.208819},{0.446405,0.617161,0.052689,-0.489044,0.616827,0.447049,-0.489047,0.052690,-0.326594},{0.446405,0.617161,0.052689,-0.489044,0.616827,0.447049,-0.489047,0.052690,-0.326594},{0.585154,0.642536,0.074886,-0.201751,0.642341,0.585492,-0.201749,0.074878,-0.808161},{0.585154,0.642536,0.074886,-0.201751,0.642341,0.585492,-0.201749,0.074878,-0.808161},{0.610758,0.655119,0.047313,-0.056713,0.654624,0.611366,-0.056709,0.047313,-0.350268},{0.610758,0.655119,0.047313,-0.056713,0.654624,0.611366,-0.056709,0.047313,-0.350268},{0.564016,0.570844,0.013090,0.076372,0.570216,0.564720,0.076373,0.013077,0.032642},{0.564016,0.570844,0.013090,0.076372,0.570216,0.564720,0.076373,0.013077,0.032642},{0.520243,0.389564,-0.021043,0.210972,0.389568,0.520099,0.210942,-0.021098,0.145484},{0.520243,0.389564,-0.021043,0.210972,0.389568,0.520099,0.210942,-0.021098,0.145484},{0.473480,0.181246,-0.055739,0.347266,0.181208,0.473302,0.347249,-0.055755,0.016795},{0.473480,0.181246,-0.055739,0.347266,0.181208,0.473302,0.347249,-0.055755,0.016795},{0.415668,0.086476,-0.083836,0.455050,0.086848,0.416368,0.455007,-0.083725,-0.203389},{0.415668,0.086476,-0.083836,0.455050,0.086848,0.416368,0.455007,-0.083725,-0.203389},{-0.186700,-0.204049,-0.069864,0.617570,-0.205648,-0.190445,0.618011,-0.069201,-0.375580},{-0.009910,-0.061013,0.000495,0.032026,-0.060946,-0.009723,0.031870,0.000520,-0.036351},{-0.009910,-0.061013,0.000495,0.032026,-0.060946,-0.009723,0.031870,0.000520,-0.036351},{-0.007838,-0.048260,-0.000378,0.024279,-0.048258,-0.007866,0.024299,-0.000377,-0.022317},{-0.007838,-0.048260,-0.000378,0.024279,-0.048258,-0.007866,0.024299,-0.000377,-0.022317},{-0.007713,-0.048190,-0.000521,0.024585,-0.048187,-0.007711,0.024585,-0.000526,-0.022022},{-0.007713,-0.048190,-0.000521,0.024585,-0.048187,-0.007711,0.024585,-0.000526,-0.022022},{-0.007732,-0.047999,-0.000635,0.024909,-0.047997,-0.007732,0.024910,-0.000639,-0.021639},{-0.007732,-0.047999,-0.000635,0.024909,-0.047997,-0.007732,0.024910,-0.000639,-0.021639},{-0.007680,-0.047847,-0.000752,0.025186,-0.047846,-0.007679,0.025185,-0.000754,-0.021280},{-0.007680,-0.047847,-0.000752,0.025186,-0.047846,-0.007679,0.025185,-0.000754,-0.021280},{-0.007657,-0.047673,-0.000869,0.025469,-0.047672,-0.007656,0.025469,-0.000869,-0.020911},{-0.007657,-0.047673,-0.000869,0.025469,-0.047672,-0.007656,0.025469,-0.000869,-0.020911},{-0.007704,-0.047442,-0.000955,0.025737,-0.047439,-0.007702,0.025736,-0.000956,-0.020495},{-0.007704,-0.047442,-0.000955,0.025737,-0.047439,-0.007702,0.025736,-0.000956,-0.020495},{-0.007654,-0.047291,-0.001098,0.026066,-0.047287,-0.007652,0.026065,-0.001098,-0.020163},{-0.007654,-0.047291,-0.001098,0.026066,-0.047287,-0.007652,0.026065,-0.001098,-0.020163},{-0.007551,-0.047167,-0.001243,0.026360,-0.047181,-0.007560,0.026360,-0.001244,-0.019857},{-0.007551,-0.047167,-0.001243,0.026360,-0.047181,-0.007560,0.026360,-0.001244,-0.019857},{-0.007645,-0.046912,-0.001317,0.026635,-0.046889,-0.007654,0.026636,-0.001318,-0.019424},{-0.007645,-0.046912,-0.001317,0.026635,-0.046889,-0.007654,0.026636,-0.001318,-0.019424},{-0.007632,-0.056242,-0.009095,0.027773,-0.056032,-0.007583,0.027741,-0.009077,-0.027276},{-0.195540,-1.245145,-0.045194,0.730785,-1.245134,-0.195532,0.731239,-0.045969,-0.167214},{-0.195540,-1.245145,-0.045194,0.730785,-1.245134,-0.195532,0.731239,-0.045969,-0.167214},{-0.114354,-0.821125,0.011426,0.604897,-0.821116,-0.114355,0.605312,0.010920,0.021010},{-0.114354,-0.821125,0.011426,0.604897,-0.821116,-0.114355,0.605312,0.010920,0.021010},{-0.088511,-0.730639,0.033092,0.632036,-0.730625,-0.088518,0.631776,0.033403,0.165720},{-0.088511,-0.730639,0.033092,0.632036,-0.730625,-0.088518,0.631776,0.033403,0.165720},{-0.064572,-0.643551,0.025714,0.608279,-0.643547,-0.064567,0.608072,0.025945,0.344192},{-0.064572,-0.643551,0.025714,0.608279,-0.643547,-0.064567,0.608072,0.025945,0.344192},{0.007707,-0.354512,0.128251,0.614596,-0.354508,0.007720,0.614572,0.128194,0.695840},{0.007707,-0.354512,0.128251,0.614596,-0.354508,0.007720,0.614572,0.128194,0.695840},{0.121872,0.168669,0.457325,0.790888,0.168684,0.121866,0.791285,0.456796,0.878473},{0.121872,0.168669,0.457325,0.790888,0.168684,0.121866,0.791285,0.456796,0.878473},{0.111505,0.324259,0.581173,0.867371,0.324251,0.111495,0.869101,0.579715,0.196011},{0.111505,0.324259,0.581173,0.867371,0.324251,0.111495,0.869101,0.579715,0.196011},{0.083715,0.422814,0.593775,0.669487,0.422799,0.083710,0.669332,0.594449,0.198570},{0.083715,0.422814,0.593775,0.669487,0.422799,0.083710,0.669332,0.594449,0.198570},{0.045888,0.514664,0.583208,0.323801,0.514695,0.045875,0.323506,0.583471,-0.038066},{0.045888,0.514664,0.583208,0.323801,0.514695,0.045875,0.323506,0.583471,-0.038066},{0.003662,0.607269,0.457499,0.111369,0.607234,0.003616,0.111352,0.457967,-0.101415},{0.003662,0.607269,0.457499,0.111369,0.607234,0.003616,0.111352,0.457967,-0.101415},{0.321805,0.853828,-0.152140,-0.210261,0.853940,0.321942,-0.208463,-0.162209,-0.167512}};

class TrajBound : public ReorientableBehavior
{
public:	

	Interpolator interp;

	TBMode mode = TB_SIT; //Current state within state-machine

	uint32_t tLast; //int used to store system time at various events

	float extDes;				 //The desired leg extension
	float angDes;				 // The desired leg angle
	float t;
	float test1;
	float test2;

	bool boolSlow = false;

	float posDes[MOTORS];
	float velDes[MOTORS];
	float accDes[MOTORS];
	float uDes[MOTORS];
	float df[MOTORS];
	float posAct;
	float velAct;
	float kp = 1;
	float kd = 0.025; // 0.02
	float kpt = 2;
	float kdt = 0.2; // 0.02
	float kpy = 0.1;//0.1;
	float kdy = 0;//0.05;
	float kiy = 0.02;
	float V = 16;
	float Ra = 0.23;
	float kt = 0.0954;
	float yawErrorInt = 0;

	float yawInit;
	float yawDes;
	float turnLeft;

	float finalTime = times[TIMESTEPS-1];


	//sig is mapped from remote; here, 3 corresponds to pushing the left stick to the right
	// which in turn forces the state machine into FH_LEAP
	void signal(uint32_t sig)
	{
		if(sig > 1)
		{
			tLast = S->millis;
		}
			
	}

	void begin()
	{
		mode = TB_STAND;			// Start behavior in STAND mode
		tLast = S->millis;		// Record the system time @ this transition
		yawInit = S->imu.euler.z;
		yawErrorInt = 0;
	}

	void update()
	{
		// if (isReorienting())
		// 	return;

		for (int j = 0; j < MOTORS; j++)
	    {
	    	posDes[j] = 0;
	    	velDes[j] = 0;
	    	uDes[j] = 0;
	    	df[j] = 0;
	    }

		
		
		if (mode == TB_SIT)
		{
			C->mode = RobotCommand_Mode_JOINT;
			for (int i = 0; i < P->joints_count; i++)
			{
				posDes[i] = 0.5;
				// Splay angle for the front/rear legs (outward splay due to fore-displacement of front legs
				// and aft-displacement of rear legs)
				// The pitch angle (S->imu.euler.y) is subtracted since we want to the set the *absolute* leg angle
				// and limb[i].setPosition(ANGLE, *) will set the angle of the leg *relative* to the robot body
				if(i==1 || i==3 || i==4 || i==6)
				{
					posDes[i] = posDes[i] - S->imu.euler.y;
				} else if(i==0 || i==2 || i==5 || i==7)
				{
					posDes[i] = posDes[i] + S->imu.euler.y;
				} else if (i == TAIL_MOT)
				{
					posDes[i] = 0;
				}
				joint[i].setGain(0.8, .003);
				joint[i].setPosition(posDes[i]);
			}
		}
		else if (mode == TB_STAND)
		{
			C->mode = RobotCommand_Mode_JOINT;		

			t = 0.00001*(100*(S->millis - tLast) % (int)(100000*finalTime));

   		    interp.getMultipleCubicSplineInterp(pos,vel,times,t,posDes);
   		    interp.getMultipleLinearInterp(vel,times,t,velDes);
   		    interp.getMultipleZOH(u,times,t,uDes);

			for (int i = 0; i<MOTORS; i++)
			{
				yawDes = yawInit + 0;
				yawErrorInt = yawErrorInt + 0.001*(yawDes - S->imu.euler.z);
				// turnLeft = kpy*(yawDes - S->imu.euler.z) + kdy*(-S->imu.angular_velocity.z) + 0.1;
				turnLeft = -map(C->behavior.twist.angular.z, -1.0, 1.0, -0.1, 0.1) + 0.03;

				if(i==0 || i==2 || i==4 || i==6)
				{
					posDes[i] = posDes[i] - turnLeft;
				} else if(i==1 || i==3 || i==5 || i==7)
				{
					posDes[i] = posDes[i] + turnLeft;
				}

				posAct = joint[i].getPosition();
				velAct = joint[i].getVelocity();

				df[i] = 1/(0.95*V)*(uDes[i]*Ra/kt + kt*joint[i].getVelocity());

				if (i == TAIL_MOT)
				{
					df[i] = 1/(0.95*V)*(uDes[i]*Ra/kt + kt*45*joint[i].getVelocity());
					joint[i].setOpenLoop(df[i] + kpt*(posDes[i] - posAct) + kdt*(velDes[i] - velAct));

				} else {
					joint[i].setOpenLoop(df[i] + kp*(posDes[i] - posAct) + kd*(velDes[i] - velAct));
				}
			}
		}
	}

	bool running()
	{
		return false;
	}
	void end()
	{
		mode = TB_SIT;
	}
};

TrajBound trajBound;

void debug()
{
	// printf("%d, ", trajBound.mode);
	// printf("Time: %4.3fs. ", trajBound.t);
	// printf("pos command: ");
	// for (int i = 0; i < P->joints_count; i++)
	// {
	// 	printf("%4.3f, ", joint[i].getOpenLoop());
	// }

	// // printf("Pos: %4.3f, ", joint[TAIL_MOT].getPosition());
	// // printf("Raw Pos: %4.3f, ",joint[TAIL_MOT].getRawPosition());
	
	// // printf("%4.3f, %4.3f, %4.3f ", trajBound.yawInit,trajBound.turnLeft, trajBound.kiy*trajBound.yawErrorInt);
	// printf("\n");

	myData_buf[0] = joint[TAIL_MOT].getPosition();
	myData_buf[1] = joint[TAIL_MOT].getVelocity();
	myData_buf[2] = joint[TAIL_MOT].getOpenLoop();
	myData_buf[3] = trajBound.t;
	write(LOGGER_FILENO, myData, 32);
}

int main(int argc, char *argv[])
{
#if defined(ROBOT_MINITAUR)
	init(RobotParams_Type_MINITAUR, argc, argv);

		// Set the joint type; see JointParams
	P->joints[TAIL_MOT].type = JointParams_Type_GRBL;

	// Set the *physical* address (e.g. etherCAT ID, PWM port, dynamixel ID, etc.)
	P->joints[TAIL_MOT].address = TAIL_MOT+1;

	// If there is a gearbox the joint electronics doesn't know about, this could be > 1.
	// Do not set to 0.
	P->joints[TAIL_MOT].gearRatio = 45.0;

	// Configure joints
	P->joints_count = S->joints_count = C->joints_count = MOTORS;
	for (int i = 0; i < P->joints_count; i++)
	{
		// Set zeros and directions
		P->joints[i].zero = motZeros[i]; //Add motor zeros from array at beginning of file
	}
	P->joints[TAIL_MOT].direction = 1;
		
#elif defined(ROBOT_MINITAUR_E)
	init(RobotParams_Type_MINITAUR_E, argc, argv);
	JoyType joyType = JoyType_FRSKY_XSR;
	ioctl(JOYSTICK_FILENO, IOCTL_CMD_JOYSTICK_SET_TYPE, &joyType);
#else
#error "Define robot type in preprocessor"
#endif


	// Uncomment to clear Bound and Walk behaviors
	// behaviors.clear();
	
	behaviors.push_back(&trajBound);

	setDebugRate(100);

	SerialPortConfig cfg;
	cfg.baud = 115200;
	cfg.mode = SERIAL_8N1;
	ioctl(STDOUT_FILENO, IOCTL_CMD_SERIAL_PORT_CFG, &cfg);


	// Run
	return begin();
}
